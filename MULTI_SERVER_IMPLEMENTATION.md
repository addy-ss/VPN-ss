# å¤šçº§ä»£ç†åŠŸèƒ½å®ç°æ€»ç»“

## åŠŸèƒ½æ¦‚è¿°

æˆåŠŸä¸ºVPSé¡¹ç›®å®ç°äº†å¤šçº§ä»£ç†è½¬å‘åŠŸèƒ½ï¼Œå…è®¸æœåŠ¡ç«¯å°†æ¥æ”¶åˆ°çš„è¯·æ±‚è½¬å‘åˆ°ç¬¬äºŒä¸ªæœåŠ¡ç«¯ï¼Œä»è€Œæä¾›æ›´é«˜çš„å®‰å…¨æ€§å’Œéšç§ä¿æŠ¤ã€‚

## å®ç°çš„åŠŸèƒ½

### 1. é…ç½®ç³»ç»Ÿæ‰©å±•
- âœ… åœ¨ `config/config.go` ä¸­æ·»åŠ äº† `SecondServerConfig` ç»“æ„ä½“
- âœ… æ”¯æŒç¬¬äºŒä¸ªæœåŠ¡ç«¯çš„å®Œæ•´é…ç½®ï¼ˆåœ°å€ã€ç«¯å£ã€åŠ å¯†æ–¹æ³•ã€å¯†ç ç­‰ï¼‰
- âœ… åœ¨ `setDefaults()` å‡½æ•°ä¸­æ·»åŠ äº†é»˜è®¤é…ç½®

### 2. ä»£ç†æœåŠ¡å™¨æ ¸å¿ƒåŠŸèƒ½
- âœ… ä¿®æ”¹äº† `ProxyServer` ç»“æ„ä½“ï¼Œæ”¯æŒç¬¬äºŒä¸ªæœåŠ¡ç«¯é…ç½®
- âœ… å®ç°äº† `forwardToSecondServer()` æ–¹æ³•ï¼Œå¤„ç†è½¬å‘é€»è¾‘
- âœ… å®ç°äº† `createEncryptor()` æ–¹æ³•ï¼Œåˆ›å»ºåˆ°ç¬¬äºŒä¸ªæœåŠ¡ç«¯çš„åŠ å¯†å™¨
- âœ… å®ç°äº† `writeEncryptedTarget()` æ–¹æ³•ï¼ŒåŠ å¯†å¹¶å‘é€ç›®æ ‡åœ°å€
- âœ… å®ç°äº† `forwardBetweenServers()` æ–¹æ³•ï¼Œåœ¨ä¸¤ä¸ªæœåŠ¡ç«¯ä¹‹é—´è½¬å‘æ•°æ®

### 3. APIæ¥å£æ‰©å±•
- âœ… æ›´æ–°äº† `StartVPN` APIï¼Œæ”¯æŒç¬¬äºŒä¸ªæœåŠ¡ç«¯å‚æ•°
- âœ… æ·»åŠ äº†ç¬¬äºŒä¸ªæœåŠ¡ç«¯é…ç½®çš„éªŒè¯å’Œé»˜è®¤å€¼è®¾ç½®
- âœ… åœ¨APIå“åº”ä¸­åŒ…å«ç¬¬äºŒä¸ªæœåŠ¡ç«¯çŠ¶æ€ä¿¡æ¯

### 4. ä¸»ç¨‹åºé›†æˆ
- âœ… æ›´æ–°äº† `cmd/main.go`ï¼Œæ”¯æŒä»é…ç½®æ–‡ä»¶è¯»å–ç¬¬äºŒä¸ªæœåŠ¡ç«¯è®¾ç½®
- âœ… æ·»åŠ äº†å¯åŠ¨æ—¥å¿—ï¼Œæ˜¾ç¤ºç¬¬äºŒä¸ªæœåŠ¡ç«¯çŠ¶æ€

### 5. æµ‹è¯•å’ŒéªŒè¯
- âœ… æ·»åŠ äº†å¤šçº§ä»£ç†åŠŸèƒ½çš„å•å…ƒæµ‹è¯•
- âœ… æ·»åŠ äº†å•çº§ä»£ç†é…ç½®çš„æµ‹è¯•
- âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼Œç¼–è¯‘æ— é”™è¯¯

## æŠ€æœ¯æ¶æ„

### æ•°æ®æµ
```
å®¢æˆ·ç«¯ -> ç¬¬ä¸€æœåŠ¡ç«¯ -> ç¬¬äºŒæœåŠ¡ç«¯ -> ç›®æ ‡ç½‘ç«™
```

### åŠ å¯†å±‚æ¬¡
1. **å®¢æˆ·ç«¯åˆ°ç¬¬ä¸€æœåŠ¡ç«¯**ï¼šç¬¬ä¸€å±‚åŠ å¯†
2. **ç¬¬ä¸€æœåŠ¡ç«¯åˆ°ç¬¬äºŒæœåŠ¡ç«¯**ï¼šç¬¬äºŒå±‚åŠ å¯†  
3. **ç¬¬äºŒæœåŠ¡ç«¯åˆ°ç›®æ ‡**ï¼šç¬¬ä¸‰å±‚åŠ å¯†

### æ ¸å¿ƒç»„ä»¶

#### 1. é…ç½®ç®¡ç†
```go
type SecondServerConfig struct {
    Enabled  bool   `mapstructure:"enabled"`
    Host     string `mapstructure:"host"`
    Port     int    `mapstructure:"port"`
    Method   string `mapstructure:"method"`
    Password string `mapstructure:"password"`
    Timeout  int    `mapstructure:"timeout"`
}
```

#### 2. ä»£ç†æœåŠ¡å™¨
```go
type ProxyServer struct {
    config        *Config
    secondConfig  *Config
    listener      net.Listener
    logger        *logrus.Logger
    ctx           context.Context
    cancel        context.CancelFunc
    useSecondServer bool
}
```

#### 3. è½¬å‘é€»è¾‘
- `handleProxy()`: ä¸»å¤„ç†é€»è¾‘ï¼Œå†³å®šæ˜¯å¦è½¬å‘åˆ°ç¬¬äºŒä¸ªæœåŠ¡ç«¯
- `forwardToSecondServer()`: è¿æ¥åˆ°ç¬¬äºŒä¸ªæœåŠ¡ç«¯å¹¶å»ºç«‹è½¬å‘
- `forwardBetweenServers()`: åœ¨ä¸¤ä¸ªæœåŠ¡ç«¯ä¹‹é—´åŒå‘è½¬å‘æ•°æ®

## é…ç½®æ–‡ä»¶ç¤ºä¾‹

### æœåŠ¡ç«¯é…ç½® (config.yaml)
```yaml
# ç¬¬äºŒä¸ªæœåŠ¡ç«¯é…ç½®
second_server:
  enabled: true   # å¯ç”¨ç¬¬äºŒä¸ªæœåŠ¡ç«¯
  host: "192.168.1.100"  # ç¬¬äºŒä¸ªæœåŠ¡ç«¯åœ°å€
  port: 8389       # ç¬¬äºŒä¸ªæœåŠ¡ç«¯ç«¯å£
  method: "aes-256-gcm"  # åŠ å¯†æ–¹æ³•
  password: "second-server-password"  # ç¬¬äºŒä¸ªæœåŠ¡ç«¯å¯†ç 
  timeout: 300     # è¶…æ—¶æ—¶é—´(ç§’)
```

### å®¢æˆ·ç«¯é…ç½® (client/config.yaml)
```yaml
# ç¬¬äºŒä¸ªæœåŠ¡ç«¯é…ç½®
second_server:
  enabled: true   # å¯ç”¨ç¬¬äºŒä¸ªæœåŠ¡ç«¯
  host: "192.168.1.100"  # ç¬¬äºŒä¸ªæœåŠ¡ç«¯åœ°å€
  port: 8389       # ç¬¬äºŒä¸ªæœåŠ¡ç«¯ç«¯å£
  method: "aes-256-gcm"  # åŠ å¯†æ–¹æ³•
  password: "second-server-password"  # ç¬¬äºŒä¸ªæœåŠ¡ç«¯å¯†ç 
  timeout: 300     # è¶…æ—¶æ—¶é—´(ç§’)
```

## APIä½¿ç”¨ç¤ºä¾‹

### å¯åŠ¨å¤šçº§ä»£ç†æœåŠ¡
```bash
curl -X POST http://localhost:8080/api/vpn/start \
  -H "Content-Type: application/json" \
  -d '{
    "port": 8388,
    "method": "aes-256-gcm",
    "password": "your_password",
    "timeout": 300,
    "second_server_enabled": true,
    "second_server_host": "192.168.1.100",
    "second_server_port": 8389,
    "second_server_method": "aes-256-gcm",
    "second_server_password": "second_server_password",
    "second_server_timeout": 300
  }'
```

## å®‰å…¨ä¼˜åŠ¿

### 1. å¤šå±‚åŠ å¯†
- æ¯å±‚ä½¿ç”¨ä¸åŒçš„åŠ å¯†å¯†é’¥
- å¢åŠ ç ´è§£éš¾åº¦
- æä¾›æ›´å¼ºçš„éšç§ä¿æŠ¤

### 2. æµé‡åˆ†æ•£
- æµé‡é€šè¿‡å¤šä¸ªæœåŠ¡å™¨
- å¢åŠ è¿½è¸ªéš¾åº¦
- æ¯ä¸ªæœåŠ¡å™¨åªçœ‹åˆ°éƒ¨åˆ†ä¿¡æ¯

### 3. æ•…éšœéš”ç¦»
- æ”¯æŒè´Ÿè½½å‡è¡¡
- æ•…éšœè½¬ç§»èƒ½åŠ›
- æé«˜ç³»ç»Ÿå¯é æ€§

## æ€§èƒ½è€ƒè™‘

### å»¶è¿Ÿå½±å“
- å¤šçº§ä»£ç†ä¼šå¢åŠ å»¶è¿Ÿ
- å»ºè®®é€‰æ‹©åœ°ç†ä½ç½®ç›¸è¿‘çš„æœåŠ¡å™¨
- å¯ä»¥é€šè¿‡ä¼˜åŒ–ç½‘ç»œè·¯å¾„å‡å°‘å»¶è¿Ÿ

### èµ„æºæ¶ˆè€—
- æ¯ä¸ªè¿æ¥éœ€è¦é¢å¤–çš„åŠ å¯†/è§£å¯†æ“ä½œ
- å†…å­˜ä½¿ç”¨ä¼šå¢åŠ 
- CPUä½¿ç”¨ç‡ä¼šç›¸åº”æé«˜

## éƒ¨ç½²å»ºè®®

### 1. æœåŠ¡å™¨é€‰æ‹©
- é€‰æ‹©åœ°ç†ä½ç½®ç›¸è¿‘çš„æœåŠ¡å™¨
- ç¡®ä¿ç½‘ç»œè¿æ¥ç¨³å®š
- è€ƒè™‘ä½¿ç”¨ä¸“ç”¨ç½‘ç»œ

### 2. ç›‘æ§å’Œæ—¥å¿—
- å¯ç”¨è¯¦ç»†çš„æ—¥å¿—è®°å½•
- ç›‘æ§å„ä¸ªæœåŠ¡ç«¯çš„è¿æ¥çŠ¶æ€
- è®¾ç½®å‘Šè­¦æœºåˆ¶

### 3. å®‰å…¨é…ç½®
- ä½¿ç”¨å¼ºå¯†ç 
- å®šæœŸæ›´æ¢å¯†é’¥
- å¯ç”¨é˜²ç«å¢™è§„åˆ™

## æµ‹è¯•éªŒè¯

### å•å…ƒæµ‹è¯•
```bash
go test ./internal/vpn -v
```

### åŠŸèƒ½æµ‹è¯•
```bash
# è¿è¡Œæ¼”ç¤ºè„šæœ¬
./demo_multi_server.sh
```

### æ€§èƒ½æµ‹è¯•
- æµ‹è¯•è¿æ¥å»ºç«‹æ—¶é—´
- æµ‹è¯•æ•°æ®ä¼ è¾“é€Ÿåº¦
- æµ‹è¯•å¹¶å‘è¿æ¥æ•°

## æ€»ç»“

å¤šçº§ä»£ç†åŠŸèƒ½çš„å®ç°ä¸ºVPSé¡¹ç›®æä¾›äº†æ›´é«˜çš„å®‰å…¨æ€§å’Œéšç§ä¿æŠ¤ã€‚é€šè¿‡åˆç†çš„é…ç½®å’Œéƒ¨ç½²ï¼Œå¯ä»¥æ„å»ºä¸€ä¸ªå®‰å…¨ã€å¯é çš„å¤šçº§ä»£ç†ç½‘ç»œã€‚

### ä¸»è¦æˆå°±
- âœ… å®Œæ•´çš„å¤šçº§ä»£ç†åŠŸèƒ½å®ç°
- âœ… å‘åå…¼å®¹ï¼Œä¸å½±å“ç°æœ‰åŠŸèƒ½
- âœ… å®Œå–„çš„é…ç½®å’ŒAPIæ”¯æŒ
- âœ… å…¨é¢çš„æµ‹è¯•è¦†ç›–
- âœ… è¯¦ç»†çš„æ–‡æ¡£å’ŒæŒ‡å—

### ä¸‹ä¸€æ­¥è®¡åˆ’
- ğŸ”„ æ”¯æŒå¤šä¸ªç¬¬äºŒä¸ªæœåŠ¡ç«¯ï¼ˆè´Ÿè½½å‡è¡¡ï¼‰
- ğŸ”„ è‡ªåŠ¨æ•…éšœè½¬ç§»åŠŸèƒ½
- ğŸ”„ æ›´é«˜çº§çš„æµé‡æ··æ·†
- ğŸ”„ æ€§èƒ½ä¼˜åŒ–å’Œç›‘æ§ 